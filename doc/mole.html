<!DOCTYPE html><html lang="en"><head><title>mole</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="mole"><meta name="groc-project-path" content="mole.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">mole.js</div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><p>We now use strict for everything since Node supports it.</p></div></div><div class="code"><div class="wrapper"><span class="s2">&quot;use strict&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Require a whole bunch of external libraries.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">exec</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">inireader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;inireader&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">iso8601</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;iso8601&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mkdirp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mkdirp&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">os</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nomnom&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pidof</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pidof&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">vpnc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vpnc&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Figure out if we are running with a TTY on stdout or not.
If not, we'll avoid using ANSI colors later on.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">isatty</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">isTTY</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The existsSync function moved between Node 0.6 and 0.8.  We just use it from
wherever we found it.</p>

<p>You'll be seeing a lot of <code>*Sync</code> calls in here. If that disturbs you, keep
in mind that this is a CLI program that runs once and then exits, not some
sort of high performance IO-bound server code, mmkay?</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">existsSync</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">;</span> <span class="c1">// Node 0.8</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existsSync</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">existsSync</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">;</span> <span class="c1">// Node 0.6 and prior</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We load our own package file to get at the version number.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;package.json&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load internal modules.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">table</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/table&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">con</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/console&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tun</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/tunnel&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">srv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/server&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set up variables pointing to our config directory, certificate files and
subdirectories for tunnels and packages.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">configDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span><span class="p">,</span> <span class="s1">&#39;.mole&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">configFile</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">configDir</span><span class="p">,</span> <span class="s1">&#39;mole.ini&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">certFile</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">configDir</span><span class="p">,</span> <span class="s1">&#39;mole.crt&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">keyFile</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">configDir</span><span class="p">,</span> <span class="s1">&#39;mole.key&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tunnelDefDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">configDir</span><span class="p">,</span> <span class="s1">&#39;tunnels&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pkgDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">configDir</span><span class="p">,</span> <span class="s1">&#39;pkg&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the tunnel and package directories. Any needed components leading up
to these directories will be created as well as needed. No harm if they
already exist.</p></div></div><div class="code"><div class="wrapper"><span class="nx">mkdirp</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">tunnelDefDir</span><span class="p">);</span>
<span class="nx">mkdirp</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">pkgDir</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Mark the entire config directory as private since we'll be storing keys and
passwords in plaintext in there.</p></div></div><div class="code"><div class="wrapper"><span class="nx">fs</span><span class="p">.</span><span class="nx">chmodSync</span><span class="p">(</span><span class="nx">configDir</span><span class="p">,</span> <span class="mi">448</span> <span class="cm">/* 0700 octal */</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load the config file. If it doesn't exist, set defaults and write a new
config file.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">inireader</span><span class="p">.</span><span class="nx">IniReader</span><span class="p">();</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">configFile</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;No config, using defaults.&#39;</span><span class="p">);</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;server.port&#39;</span><span class="p">,</span> <span class="mi">9443</span><span class="p">);</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">write</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set up the help text that will be appended after the commands and options
summary when the user makes an error or runs mole without parameters.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">helptext</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;Version:&#39;</span><span class="p">,</span>
      <span class="s1">&#39;  mole v&#39;</span> <span class="o">+</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;\t(https://github.com/calmh/mole)&#39;</span><span class="p">,</span>
      <span class="s1">&#39;  node &#39;</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
      <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Examples:&#39;</span><span class="p">,</span>
      <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Register with server &quot;mole.example.com&quot; and a token:&#39;</span><span class="p">,</span>
      <span class="s1">&#39;  mole register mole.example.com 80721953-b4f2-450e-aaf4-a1c0c7599ec2&#39;</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span>
      <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;List available tunnels:&#39;</span><span class="p">,</span>
      <span class="s1">&#39;  mole list&#39;</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span>
      <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Dig a tunnel to &quot;operator3&quot;:&#39;</span><span class="p">,</span>
      <span class="s1">&#39;  mole dig operator3&#39;</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span>
      <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Fetch new and updated tunnel specifications from the server:&#39;</span><span class="p">,</span>
      <span class="s1">&#39;  mole pull&#39;</span><span class="p">.</span><span class="nx">bold</span>
<span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the name of our 'script'.</p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">script</span><span class="p">(</span><span class="s1">&#39;mole&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>dig &lt;destination&gt; [host]</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;dig&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Dig a tunnel to the destination&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;tunnel&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Tunnel name or file name&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Host name within tunnel definition&#39;</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">dig</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>list</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;List available tunnel definitions&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">list</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>pull</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;pull&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Get tunnel definitions from the server&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">pull</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>push &lt;file&gt;</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;push&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Send a tunnel definition to the server&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;File name&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">push</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>register &lt;host&gt; &lt;token&gt;</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Register with a mole server&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Server name&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;One time registration token&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">abbr</span><span class="o">:</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="nx">metafile</span><span class="o">:</span> <span class="s1">&#39;PORT&#39;</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Server port (default 9443)&#39;</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="mi">9443</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">register</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>gettoken</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;gettoken&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Generate a new registration token&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>export &lt;tunnel&gt; &lt;file&gt;</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;tunnel&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Tunnel name&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;File name to write tunnel definition to&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Export tunnel definition to a file&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">exportf</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>newuser [-a] &lt;name&gt;</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;newuser&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;User name&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">flag</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">abbr</span><span class="o">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Create an admin user&#39;</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Create a new user (requires admin privileges)&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>deluser &lt;name&gt;</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;deluser&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;User name&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Delete a user (requires admin privileges)&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">delUser</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>install &lt;pkg&gt;</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;pkg&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Package name&#39;</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="s1">&#39;Install an optional package, fetched from the server&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">install</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>-d</code> always turns on debug.</p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">abbr</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">flag</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Display debug output&#39;</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>-h</code> shows help. This is actually implemented totally by <code>nomnom</code>, but we
need to define the option so it shows up in the usage information.</p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">abbr</span><span class="o">:</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="nx">flag</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Display command help&#39;</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If no command was given, we print the usage information and exit. We also
tack on the <code>.help</code> call to set the global help text here.  I'd rather do
that in a separate call on <code>parser</code> instead of chaining after <code>.nocommand</code>
etc, but that doesn't actually work for reasons I don't understand.</p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">nocommand</span><span class="p">()</span>
<span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">getUsage</span><span class="p">());</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">help</span><span class="p">(</span><span class="nx">isatty</span> <span class="o">?</span> <span class="nx">helptext</span> <span class="o">:</span> <span class="nx">helptext</span><span class="p">.</span><span class="nx">stripColors</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse command line arguments. This will call the defined callbacks for matching commands.</p></div></div><div class="code"><div class="wrapper"><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to read our certificates and pass them to the <code>server</code> instance. Fail
silently if there are no certificates, since we might simply not be
registered yet.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">readCert</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">cert</span><span class="p">;</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Trying to load &#39;</span> <span class="o">+</span> <span class="nx">keyFile</span><span class="p">);</span>
        <span class="nx">key</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">keyFile</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Trying to load &#39;</span> <span class="o">+</span> <span class="nx">certFile</span><span class="p">);</span>
        <span class="nx">cert</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">certFile</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">cert</span><span class="o">:</span> <span class="nx">cert</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;No certificate loaded&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initialize stuff given the options from <code>nomnom</code>. This must be called early from every command callback.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">enableDebug</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The server code will check the certificate fingerprint if we have one
stored from before.  If not, we'll store the fingerprint on <code>register</code>,
thus effectively locking the client to the server it registered with and
preventing some tampering scenarios.</p></div></div><div class="code"><div class="wrapper"> 
    <span class="nx">srv</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span> <span class="nx">host</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;server.host&#39;</span><span class="p">),</span> <span class="nx">port</span><span class="o">:</span>
             <span class="nx">config</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;server.port&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">9443</span><span class="p">,</span> <span class="nx">fingerprint</span><span class="o">:</span>
             <span class="nx">config</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;server.fingerprint&#39;</span><span class="p">)</span> <span class="p">});</span>

    <span class="nx">readCert</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">register</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>

    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Requesting registration from server &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">server</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the server and port we received from parameters in the config file,
and tell the server code to use them.  We don't save the config just
yet, though.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">config</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;server.host&#39;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">server</span><span class="p">);</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;server.port&#39;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
    <span class="nx">srv</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span> <span class="nx">host</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to register with the server. If it fails, a fatal error will be
printed by the server code and the callback will never be called.  If it
succeeds, we'll get our certificates and the server fingerprint in the
callback.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">srv</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Received certificate and key from server&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Save the certificates and fingerprint for later.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">certFile</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">cert</span><span class="p">);</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">keyFile</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;server.fingerprint&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">fingerprint</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Save the config file since we've verified the server and port and
got the fingerprint.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">config</span><span class="p">.</span><span class="nx">write</span><span class="p">();</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;Registered&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read our newly minted certificates and do a <code>pull</code> to get tunnel
definitions.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">readCert</span><span class="p">();</span>
        <span class="nx">pull</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">token</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>

    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Requesting new token from server&#39;</span><span class="p">);</span>
    <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;A token can be used only once&#39;</span><span class="p">);</span>
    <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Only the most recently generated token is valid&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Request a token from the server. On success, the callback will be called
with the token and we simply print it out.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">srv</span><span class="p">.</span><span class="nx">token</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">list</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a sorted list of all files in the tunnel directory.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;listing files in &#39;</span> <span class="o">+</span> <span class="nx">tunnelDefDir</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">tunnelDefDir</span><span class="p">);</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Got &#39;</span> <span class="o">+</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; files&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build a table with information about the tunnel definitions. Basically,
load each of them, create a row with information and push that row to
the table.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">rows</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tname</span> <span class="o">=</span> <span class="nx">tun</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">tun</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">tunnelDefDir</span><span class="p">,</span> <span class="nx">file</span><span class="p">));</span>
            <span class="kd">var</span> <span class="nx">descr</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>FIXME: For lots of hosts, this isn't all that useful since it'll be truncated by the table formatter.</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">hosts</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">hosts</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">mtime</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">mdate</span> <span class="o">=</span> <span class="nx">iso8601</span><span class="p">.</span><span class="nx">fromDate</span><span class="p">(</span><span class="nx">mtime</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="nx">rows</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span> <span class="nx">tname</span><span class="p">,</span> <span class="nx">descr</span><span class="p">,</span> <span class="nx">hosts</span><span class="p">,</span> <span class="nx">mdate</span> <span class="p">]);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we couldn't load/parse the file for some reason, simply mark it as corrupt.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">rows</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span> <span class="nx">tname</span><span class="p">,</span> <span class="s1">&#39;--Corrupt--&#39;</span><span class="p">,</span> <span class="s1">&#39;--Corrupt--&#39;</span><span class="p">,</span> <span class="s1">&#39;--Corrupt--&#39;</span> <span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Format the table using the specified headers and the rows from above.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">table</span><span class="p">([</span> <span class="s1">&#39;Tunnel&#39;</span><span class="p">,</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="s1">&#39;Hosts&#39;</span><span class="p">,</span> <span class="s1">&#39;Modified&#39;</span> <span class="p">],</span> <span class="nx">rows</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">pull</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the list of tunnel definitions from the server. The list includes
(name, mtime) for each tunnel. We'll use the <code>mtime</code> to figure out if we
need to download the definition or not.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Requesting tunnel list from server&#39;</span><span class="p">);</span>
    <span class="nx">srv</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Got &#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; entries&#39;</span><span class="p">);</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We use this to keep track of the number of outstanding requests and
to print a message when every request has finished.</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">inProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">done</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">inProgress</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">inProgress</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; tunnel definitions in sync&#39;</span><span class="p">);</span>
                <span class="nx">inProgress</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">result</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">inProgress</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Figure out the local filename that corresponds to this tunnel, if we have it.</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">local</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">tunnelDefDir</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We need to fetch the file only if we either don't already have
it, or if the mtime as sent by the server differs from what we
have locally.</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">local</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">fetch</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">local</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">!==</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">mtime</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">fetch</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we need to fetch a tunnel definition, send a server request to do so.</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="nx">fetch</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">srv</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When the request completes, we save the file and set the
mtime to match that sent by the server. The server sends
it in milliseconds since that's what Javascript
timestamps usually are, but utimesSync expects seconds.</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">local</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>

                    <span class="kd">var</span> <span class="nx">mtime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">mtime</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
                    <span class="nx">fs</span><span class="p">.</span><span class="nx">utimesSync</span><span class="p">(</span><span class="nx">local</span><span class="p">,</span> <span class="nx">mtime</span><span class="p">,</span> <span class="nx">mtime</span><span class="p">);</span>

                    <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;Pulled &#39;</span> <span class="o">+</span> <span class="nx">tun</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Mark this request as completed, print out status if it was the last one.</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">done</span><span class="p">();</span>
                <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Mark this request as completed. We don't do it immediately
since that would result in the <code>inProgress</code> counter flapping
between 1 and 0 when we didn't need to fetch anything.
Instead, queue the call for the next tick, when <code>inProgress</code>
has been incremented all the way.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The user presumably want's to be up to date, so we fetch the latest
version number for mole from the npm repository and print a 'time to
upgrade'-message if there's a mismatch.</p></div></div><div class="code"><div class="wrapper">   
    <span class="nx">version</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;mole&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ver</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">ver</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ver</span> <span class="o">!==</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;You are using mole v&#39;</span> <span class="o">+</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;; the latest version is v&#39;</span> <span class="o">+</span> <span class="nx">ver</span><span class="p">);</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Use &quot;sudo npm -g update mole&quot; to upgrade&#39;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;You are using the latest version of mole&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">push</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We load the tunnel, which will cause some validation of it to happen. We
don't want to push files that are completely broken.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Testing &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">tun</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;It passed validation&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We read the file to a buffer to send to the server. There should be no
errors here since the tunne load and check above succeeded.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Reading &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Send the data to the server. We'll only get the callback if the upload
succeeds.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">srv</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">file</span><span class="p">),</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;Sent &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; bytes&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">newUser</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a new user on the server. If the call succeeds, we'll get the
callback with the one-time token for the new user.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Requesting user &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">srv</span><span class="p">.</span><span class="nx">newUser</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">delUser</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Delete a user from the server. As always, we only get the callback if
everything went well.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Deleting user &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">srv</span><span class="p">.</span><span class="nx">delUser</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">dig</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Before we do any digging, we make sure that <code>expect</code> is available.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;expect -v&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">con</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">trim</span><span class="p">());</span>
            <span class="nx">con</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Verify that &quot;expect&quot; is installed and available in the path.&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
            <span class="nx">digReal</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">tunnel</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">debug</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Here's the real meat of <code>mole</code>, the tunnel digging part.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">digReal</span><span class="p">(</span><span class="nx">tunnel</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">config</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">sshConfig</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/ssh-config&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load a configuration, generate a temporary filename for ssh config.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Loading tunnel&#39;</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="nx">tun</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">tunnel</span><span class="p">,</span> <span class="nx">tunnelDefDir</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">sshConfig</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="nx">suffix</span><span class="o">:</span> <span class="s1">&#39;.ssh.conf&#39;</span><span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If a specific host was requested, we modify the configuration to use
that host as <code>main</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Using specified main host &#39;</span> <span class="o">+</span> <span class="nx">host</span><span class="p">);</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="nx">host</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create and save the ssh config. We add some defaults to the top to avoid
complaints about missing or mismatching host keys.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Creating ssh configuration&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">defaults</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Host *&#39;</span><span class="p">,</span>
        <span class="s1">&#39;  UserKnownHostsFile /dev/null&#39;</span><span class="p">,</span>
        <span class="s1">&#39;  StrictHostKeyChecking no&#39;</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">conf</span> <span class="o">=</span> <span class="nx">defaults</span> <span class="o">+</span> <span class="nx">sshConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">sshConfig</span><span class="p">,</span> <span class="nx">conf</span><span class="p">);</span>
    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">sshConfig</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the tunnel definition specifies a VPN connection, we need to get that
up and running before we call expect.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">vpnc</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>First we make sure that <code>vpnc</code> is actually installed, or exit with a
helpful suggestion if it's not.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">vpnc</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;vpnc unavailable; try &quot;mole install vpnc&quot;&#39;</span><span class="p">);</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="s1">&#39;Not continuing without vpnc&#39;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Using &#39;</span> <span class="o">+</span>  <span class="nx">result</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If vpnc is already running, it's almost certainly going to
fail to bring up one more VPN connection. So if that's the
case, exit with an error.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">pidof</span><span class="p">(</span><span class="s1">&#39;vpnc&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="s1">&#39;could not check if vpnc was running&#39;</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pid</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="s1">&#39;vpnc already running, will not start another instance&#39;</span><span class="p">);</span>
                    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to connect the VPN. If it fails, exit with an error,
otherwise proceed to start expect and to the real SSH
tunnelling.</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Connecting VPN; you might be asked for your local (sudo) password now&#39;</span><span class="p">);</span>
                    <span class="nx">vpnc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">vpnc</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">vpnRoutes</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="s1">&#39;vpnc returned an error - investigate and act on it, nothing more I can do :(&#39;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;VPN connected. Should the login sequence fail, you can disconnect the VPN&#39;</span><span class="p">);</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;manually by running &quot;sudo &#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">vpncDisconnect</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
                        <span class="nx">launchExpect</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">debug</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We don't need a VPN connection, so go directly to the expect step.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">launchExpect</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">debug</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">launchExpect</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">setupLocalIPs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/setup-local-ips&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">expectConfig</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/expect-config&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create and save the expect script that's going to drive the session.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Creating expect script&#39;</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">expectConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">debug</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">expectFile</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="nx">suffix</span><span class="o">:</span> <span class="s1">&#39;.expect&#39;</span><span class="p">});</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">expectFile</span><span class="p">,</span> <span class="nx">expect</span><span class="p">);</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">expectFile</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set up local IP:s needed for forwarding. If it fails, we remove the
forwardings from the configuration and warn the user, but proceed
anyway.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Setting up local IP:s for forwarding&#39;</span><span class="p">);</span>
    <span class="nx">setupLocalIPs</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">con</span><span class="p">.</span><span class="nx">warning</span><span class="p">(</span><span class="s1">&#39;Failed to set up IP:s for forwarding. Continuing without forwarding.&#39;</span><span class="p">);</span>
            <span class="k">delete</span> <span class="nx">config</span><span class="p">.</span><span class="nx">forwards</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start the expect script and wait for it to exit. We use the
deprecated <code>customFds</code> option to connect the script to the tty so
the user can interact with it. When we migrate to Node 0.8, there's
a supported <code>stdio: inherit</code> option we can use instead.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Hang on, digging the tunnel&#39;</span><span class="p">);</span>
        <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;expect&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">expectFile</span> <span class="p">],</span> <span class="p">{</span> <span class="nx">customFds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The script has exited, so we try to clean up after us.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">fs</span><span class="p">.</span><span class="nx">unlinkSync</span><span class="p">(</span><span class="nx">expectFile</span><span class="p">);</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">unlinkSync</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">sshConfig</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>FIXME: Unlink ssh keys</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If a VPN was connected, now is the time to disconnect it. We
don't treat errors here as fatal since there could be more
cleanup to do later on and we're anyway exiting soon.</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">vpnc</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Disconnecting VPN; you might be asked for your local (sudo) password now&#39;</span><span class="p">);</span>
                <span class="nx">vpnc</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;VPN disconnection failed&#39;</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;VPN disconnected&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Print final status message. If things seems to have failed,
suggest turning on debugging or talking to the author of the
tunnel definition.</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;Great success&#39;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Unsuccessful&#39;</span><span class="p">);</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Debug tunnel definition by &quot;mole dig -d &lt;tunnel&gt;&quot; or talk to the author:&#39;</span><span class="p">);</span>
                <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">author</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">exportf</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">config</span><span class="p">;</span>

    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Loading tunnel&#39;</span><span class="p">);</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="nx">tun</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">tunnel</span><span class="p">,</span> <span class="nx">tunnelDefDir</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Saving to INI format&#39;</span><span class="p">);</span>
    <span class="nx">tun</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>

    <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">install</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">init</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">pkg</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">platform</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">arch</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">release</span><span class="p">()</span> <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.tar.gz&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">local</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">pkgDir</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">path</span><span class="p">();</span>
    <span class="nx">mkdirp</span><span class="p">(</span><span class="nx">tmp</span><span class="p">);</span>

    <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Fetching &#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">);</span>
    <span class="nx">srv</span><span class="p">.</span><span class="nx">saveBin</span><span class="p">(</span><span class="s1">&#39;/extra/&#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">local</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Unpacking &#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">);</span>
        <span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;cd &#39;</span> <span class="o">+</span> <span class="nx">tmp</span> <span class="o">+</span> <span class="s1">&#39; &amp;&amp; tar zxf &#39;</span> <span class="o">+</span> <span class="nx">local</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">con</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Extracted in &#39;</span> <span class="o">+</span> <span class="nx">tmp</span><span class="p">);</span>
            <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Running installation, you might now be asked for your local (sudo) password.&#39;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">inst</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;sudo&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">tmp</span><span class="p">,</span> <span class="s1">&#39;install.sh&#39;</span><span class="p">),</span> <span class="nx">tmp</span> <span class="p">],</span> <span class="p">{</span> <span class="nx">customFds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">});</span>
            <span class="nx">inst</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">con</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="s1">&#39;Installation complete&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">con</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Installation failed. Sorry.&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span> <span class="nx">local</span><span class="p">);</span>
<span class="p">}</span></div></div></div></div></body></html>